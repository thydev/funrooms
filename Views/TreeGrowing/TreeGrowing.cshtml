
<h1>Welcome to the Growing Tree Room</h1>
<div class="row">
    <div id="users"></div>
</div>
<div class="newgame text-center">
    <br>
    <h2 class="playtext">Ready to Play?</h2>
    <h2 class="readytext">Waiting for Another User...</h2>
    <button class="btn btn-lg btn-success gamestart">Start Game</button>
</div>

<div id="container">
    <div class="row">
        <div class="col-md-6">
            <h2 id="gestdirection">Directions:</h2>
            <h4>Wave Hand Up to Grow Tree</h4>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <h4 id="counting">0</h4>
        </div>
    </div>
    <div id="treecontainer" class="row">
        
        </div>
    </div>
</div>

<script src="~/lib/signalr/signalr.js"></script>
<script src="~/js/gest.js"></script>
<script>
    var usercolorobj = {};
    var thisplayer = "";
    var count = 0;
    var color = ["red", "green", "blue", "purple", "darkgold", "black", "orange", "dodgerblue", "violet", "tomato", "magenta"];
    $(document).ready(function(){
        var userid = {};
        $("#container").hide();
        $("#counting").hide();
        $(".playtext").hide();
        $(".gamestart").hide();
        var usercount = 0;
        //hide start game button until 2 players are in lobby
        console.log("ready");
        const treehub = new signalR.HubConnection(
            "/growingtree", { logger: signalR.LogLevel.Information });

        //////// Testing below for 2 player
        treehub.on('SetUsersOnline', usersOnline => {
            usersOnline.forEach(user => addUserOnline(user));
        });
//
    treehub.on('UsersJoined', users => {
        users.forEach(user => {
            addUserOnline(user);
        });
    });

    treehub.on('UsersLeft', users => {
        users.forEach(user => {
            document.getElementById(user.connectionId).outerHTML = '';
            var user = userid[user.name];
            document.getElementById(user).parentElement.outerHTML = '';
            console.log(user, "thisuser id");
            
            
        });
        usercount--;
        console.log(usercount);
        if(usercount<2){
            $(".gamestart").hide();
            $(".playtext").hide();
            $(".container").hide();
            $(".newgame").show();
            $(".readytext").show();
        }
    });

//use code below to update tree graph
    treehub.on('Send', (userName) => {
        var nameElement = document.createElement('b');
        nameElement.innerText = userName + '   ';
        for(var key in usercolorobj){
            if(key == userName){
                nameElement.style.color = usercolorobj[key];
                break;
            }
        }
        var child = document.createElement('h3');
        child.className = "col-md-6";
        child.appendChild(nameElement);
        document.getElementById('users').appendChild(child);
    });
        ////////
        treehub.on("CounterClient", num => {
            $("#counting").text(num);
            console.log(num);
            //ends game once num hits 40
            if(num == 40){
                $("#container").html("<div class='text-center'><h1>Game Over</h1><p><a class='btn btn-success' role='button' href='/treegrowing'>Play Again?</a></p><p>Your Score = "+num+"</p></div>");
                gest.stop();
            }
        });
        treehub.on("GrowTreeWidthClient", width => {
        $(".tree").width(width);
            }); 
        treehub.on("GrowTreeHeightClient", height => {
        $(".tree").height(height);
            });
        
        treehub.start();
        gest.options.subscribeWithCallback(function(gesture) {
            var message = '';
            console.log(gesture.direction);

            if (gesture.direction) {
                message = gesture.direction;
                //console.log(user);
                $tree = $(".tree");
                console.log($($tree).width());
                console.log($($tree).height());
                if (gesture.up) {
                    treehub.invoke("GrowTreeWidth", $($tree).width(), gesture.up)
                    treehub.invoke("GrowTreeHeight", $($tree).height(), gesture.up)
                        .catch(err => console.error);
                    var num = $("#counting").text();
                    treehub.invoke("Counter", num)
                        .catch(err => console.error);
                }
            } else {
                message = gesture.error.message;
            } 

        });
        //Testing below:
        function addUserOnline(user) {
            if (document.getElementById(user.connectionId)) {
                return;
            }
            usercount++;
            console.log(usercount);
            if(usercount > 1){
                $(".gamestart").show();
                $(".playtext").show();
                $(".readytext").hide();
            }
            var userLi = document.createElement('h3');
            userLi.innerText = `${user.name}`;
            userLi.id = user.connectionId;
            userLi.className = "col-md-6 text-center";
            while(count<color.length){
            var usercolor = color[count];
            userLi.style.color = usercolor;
            userid[user.name] = user.connectionId;
            usercolorobj[user.name] = usercolor;
                count++;
                if(count == 10){
                    count = 0;
                }
                break;
            }
            var treediv = document.createElement('div');
            treediv.className = "col-md-6";
            var treepic = document.createElement('img');
            treepic.className = "tree center";
            treepic.src = "/images/pine-tree-b.jpg";
            treepic.width = "80";
            treepic.height = "100";
            //connection id may need to be changed.
            treepic.id = user.connectionId;
            treediv.appendChild(treepic);
            document.getElementById("treecontainer").appendChild(treediv);

            document.getElementById('users').appendChild(userLi);
        }
    ///
        

        $(".gamestart").click(function(e){
            gest.start();
            console.log("started");
            e.preventDefault();
            $("#container").show();
            $(".newgame").hide();
            //if(e){
            //    treehub.invoke("StartGame", e);
                
            //}
        });
    });

</script>